#!/usr/bin/make -f
# -*- makefile -*-
# debian makefile for weewx
# Copyright 2013-2023 Matthew Wall

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

PKG=weewx
PYTHON=python3
SRC=$(CURDIR)
DST=$(CURDIR)/debian/$(PKG)
DST_EXECDIR=$(DST)/usr/bin
DST_BINDIR =$(DST)/usr/share/weewx
DST_DOCDIR =$(DST)/usr/share/doc/weewx
DST_CFGDIR =$(DST)/etc/weewx
DST_USERDIR =$(DST)/etc/weewx/user
DST_SYSTEMDDIR=$(DST)/etc/systemd/system

# these are the entry points
ENTRIES=weewxd weectl wee_import wee_reports

%:
	dh $@ --with python3

override_dh_auto_clean:
	dh_auto_clean
	rm -rf build dist
	rm -f *.egg-info

# this install rule duplicates what the weewx setup.py would do
install:
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs

# create the directory structure
	mkdir -p $(DST_EXECDIR)
	mkdir -p $(DST_BINDIR)
	mkdir -p $(DST_DOCDIR)
	mkdir -p $(DST_CFGDIR)
	mkdir -p $(DST_USERDIR)
	mkdir -p $(DST)/etc/default
	mkdir -p $(DST_SYSTEMDDIR)

# copy the weewx code
	cp -r $(SRC)/src/* $(DST_BINDIR)

# get rid of the stuff we do not want or need
	rm -rf $(DST_BINDIR)/weewx_data/util
	for d in weecfg weectllib weedb weeplot weeutil weewx/drivers weewx; do \
  rm -rf $(DST_BINDIR)/$d; \
done

# create the inital user code area
	cp $(SRC)/src/weewx_data/bin/user/__init__.py $(DST_USERDIR)
	cp $(SRC)/src/weewx_data/bin/user/extensions.py $(DST_USERDIR)

# copy the ancillary files to the correct location
	cp -r $(SRC)/src/weewx_data/docs/* $(DST_DOCDIR)
	cp -r $(SRC)/src/weewx_data/examples $(DST_DOCDIR)
	cp -r $(SRC)/src/weewx_data/skins $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/apache $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/import $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/logrotate.d $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/logwatch $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/rsyslog.d $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/tmpfiles.d $(DST_CFGDIR)
	cp -r $(SRC)/src/weewx_data/util/udev $(DST_CFGDIR)

# create the weewx configuration
	cat $(SRC)/src/weewx_data/weewx.conf | sed \
 -e 's%^WEEWX_ROOT =.*%WEEWX_ROOT = /etc/weewx%' \
 -e 's%SKIN_ROOT =.*%SKIN_ROOT = skins%' \
 -e 's%HTML_ROOT = public_html%HTML_ROOT = /var/www/html/weewx%' \
 -e 's%SQLITE_ROOT = .*%SQLITE_ROOT = /var/lib/weewx%' \
 > $(DST_CFGDIR)/weewx.conf

# make a virgin copy of the configuration file
	cp $(DST_CFGDIR)/weewx.conf $(DST_CFGDIR)/weewx.conf.dist

# create the init configuration
	cat $(SRC)/src/weewx_data/util/systemd/weewx.service | sed \
 -e 's%ExecStart=.*%ExecStart=/usr/bin/weewxd /etc/weewx/weewx.conf%' \
 > $(DST_SYSTEMDDIR)/weewx.service

# create the entry points
	for f in $(ENTRIES); do \
  cp $(SRC)/src/weewx_data/util/scripts/$$f $(DST)/usr/bin; \
done

# configure defaults
	cat $(SRC)/src/weewx_data/util/default/weewx | sed \
 -e 's%WEEWX_PYTHON=.*%WEEWX_PYTHON=$(PYTHON)%' \
 -e 's%WEEWX_BINDIR=.*%WEEWX_BINDIR=/usr/share/weewx%' \
 -e 's%WEEWX_BIN=.*%WEEWX_BIN=/usr/bin/weewxd%' \
 -e 's%WEEWX_CFG=.*%WEEWX_CFG=/etc/weewx/weewx.conf%' \
 > $(DST)/etc/default/weewx

# additional debian control files that dpkg-buildpackage seems to ignore
	mkdir -p $(DST)/DEBIAN
	cp $(SRC)/debian/config $(DST)/DEBIAN
	cp $(SRC)/debian/templates $(DST)/DEBIAN

binary-indep: install
	dh_installchangelogs
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb -- -Zgzip

binary-arch:

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install configure
